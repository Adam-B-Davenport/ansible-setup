#!/usr/bin/env bash
set -euo pipefail

# docker-backup.sh â€” Backup /media/docker to /tank/backups/docker using rsync + hard links
# Generated by Ansible role 'backup'

MODE="daily"  # daily|weekly
while [[ $# -gt 0 ]]; do
  case "$1" in
    -m|--mode)
      MODE="$2"; shift 2;;
    --mode=*)
      MODE="${1#*=}"; shift;;
    -h|--help)
      echo "Usage: $0 [--mode daily|weekly]"; exit 0;;
    *) echo "Unknown argument: $1"; exit 2;;
  esac
done

SOURCE_DIR="{{ backup_source_dir }}"/
DEST_ROOT="{{ backup_dest_dir }}"
KEEP_DAILY={{ backup_keep_daily }}
KEEP_WEEKLY={{ backup_keep_weekly }}
STOP_CONTAINERS={{ '1' if backup_stop_docker else '0' }}

RSYNC_EXCLUDES=()
{% for pat in backup_excludes %}
RSYNC_EXCLUDES+=(--exclude='{{ pat }}')
{% endfor %}

STAMP=$(date +%Y-%m-%d_%H%M%S)
DATE=$(date +%Y-%m-%d)

if [[ "$MODE" != "daily" && "$MODE" != "weekly" ]]; then
  echo "[ERROR] MODE must be daily or weekly" >&2
  exit 2
fi

TARGET_DIR="$DEST_ROOT/$MODE/$DATE"
LATEST_LINK="$DEST_ROOT/$MODE/latest"
PREV_LINK="$DEST_ROOT/$MODE/prev"

mkdir -p "$DEST_ROOT/$MODE"

# Determine link-dest from latest if exists
LINK_DEST=()
if [[ -L "$LATEST_LINK" && -d "$LATEST_LINK" ]]; then
  LINK_DEST=(--link-dest="$LATEST_LINK")
fi

# Optionally stop all running containers for consistency
STOPPED_IDS=()
if [[ "$STOP_CONTAINERS" == "1" ]]; then
  if command -v docker >/dev/null 2>&1; then
    mapfile -t STOPPED_IDS < <(docker ps -q)
    if [[ ${#STOPPED_IDS[@]} -gt 0 ]]; then
      echo "[INFO] Stopping ${#STOPPED_IDS[@]} running containers..."
      docker stop "${STOPPED_IDS[@]}" >/dev/null
    else
      echo "[INFO] No running containers to stop."
    fi
  else
    echo "[WARN] docker CLI not found; skipping stop." >&2
  fi
fi

# Perform rsync to a temp directory then atomically move
TMP_DIR="$DEST_ROOT/.incomplete-${MODE}-${STAMP}"
mkdir -p "$TMP_DIR"

RSYNC_OPTS=(
  -aHAX --numeric-ids --delete --delete-excluded
  --info=stats2,misc2,progress2 --human-readable
  "${RSYNC_EXCLUDES[@]}"
  "${LINK_DEST[@]}"
)

set +e
rsync "${RSYNC_OPTS[@]}" "$SOURCE_DIR" "$TMP_DIR/"
RSYNC_STATUS=$?
set -e

if [[ $RSYNC_STATUS -ne 0 ]]; then
  echo "[ERROR] rsync failed with code $RSYNC_STATUS" >&2
  # Attempt to start containers back up before exiting
  if [[ "$STOP_CONTAINERS" == "1" && ${#STOPPED_IDS[@]} -gt 0 ]]; then
    docker start "${STOPPED_IDS[@]}" || true
  fi
  exit $RSYNC_STATUS
fi

# Move into place atomically and update symlinks
mv "$TMP_DIR" "$TARGET_DIR"
if [[ -L "$LATEST_LINK" ]]; then
  ln -sfn "$(readlink -f "$LATEST_LINK")" "$PREV_LINK"
fi
ln -sfn "$TARGET_DIR" "$LATEST_LINK"

# Prune old backups beyond retention
prune_old() {
  local droot="$1"
  local keep="$2"
  mapfile -t entries < <(find "$droot" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | sort)
  local count=${#entries[@]}
  local to_delete=$(( count - keep ))
  if (( to_delete > 0 )); then
    for ((i=0; i<to_delete; i++)); do
      local victim="$droot/${entries[$i]}"
      if [[ -d "$victim" && "$victim" != *"latest"* ]]; then
        echo "[INFO] Pruning $victim"
        rm -rf --one-file-system "$victim"
      fi
    done
  fi
}

if [[ "$MODE" == "daily" ]]; then
  prune_old "$DEST_ROOT/daily" "$KEEP_DAILY"
else
  prune_old "$DEST_ROOT/weekly" "$KEEP_WEEKLY"
fi

# Start containers back
if [[ "$STOP_CONTAINERS" == "1" && ${#STOPPED_IDS[@]} -gt 0 ]]; then
  echo "[INFO] Starting containers..."
  docker start "${STOPPED_IDS[@]}" || true
fi

echo "[INFO] Backup $MODE completed: $TARGET_DIR"
